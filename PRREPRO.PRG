if wprotros <> "A"
   return
endif
@ 10,55 CLEAR TO 14,76
@ 10,55 to 14,76
@ 11,56 say "A¥O      :"
@ 12,56 say "TIPO     :"
@ 13,56 say "ORIGEN   :"
@ 11,66 GET WPREANO
@ 12,66 GET WPRETIP
@ 13,66 GET WPREORI
READ
IF READKEY() = 12 .OR. READKEY() = 268
   RETURN
ENDIF
IF WPREANO=SPACE(2).OR.;
   WPRETIP=SPACE(2).OR.;
   WPREORI=SPACE(3)
   STORE "SELECCION DE CODIGOS INCOMPLETA, REINTENTE" TO MES
   DO AVISO WITH MES
   LOOP
ENDIF
STORE "OPCIONES: (C)ONTINUAR, (S)ALIR" TO TEX
STORE "CS" TO WCH
DO PREGUNTA
IF WCH = "S"
   RETURN
ENDIF
*** DATOS DEL SECTOR
STORE WPREANO+WPRETIP+WPREORI TO WCLAVE

SELECT 1
USE PRCTAS INDEX PRCTAS1
SEEK WCLAVE
IF .NOT. FOUND()
   STORE "LA SELECCION DE CODIGOS DEL PLAN DE CUENTAS NO EXISTE. OPRIMA <ENTER>" TO MES
   DO AVISO WITH MES
   RETURN
ENDIF
DO FILLOC
DO WHILE .NOT.EOF().AND.PREANO=WPREANO.AND.PRETIP=WPRETIP.AND.PREORI=WPREORI
   STORE SPACE(30) TO WCUENTA0
   DO ARMACOD0
   STORE "LIMPIANDO CUENTA: "+wcuenta0+", FAVOR ESPERAR..." TO MES
   DO MENSAJE WITH MES
   STORE LEN(RTRIM(WCUENTA0)) TO WLARCOD
   IF WLARCOD <> 30
      REPLACE INVE   WITH 0
      REPLACE CORR   WITH 0
      REPLACE ORIG   WITH 0
   ENDIF
   REPLACE TRAS      WITH 0
   REPLACE INCR      WITH 0
   REPLACE COMP      WITH 0
   REPLACE CAUS      WITH 0
   REPLACE PAGA      WITH 0
   SKIP
ENDDO
SEEK WCLAVE
DO WHILE .NOT.EOF().AND.PREANO=WPREANO.AND.PRETIP=WPRETIP.AND.PREORI=WPREORI
   STORE SPACE(30) TO WCUENTA0
   DO ARMACOD0
   STORE "REPROCESANDO CUENTA: "+wcuenta0+", FAVOR ESPERAR..." TO MES
   DO MENSAJE WITH MES
   STORE LEN(RTRIM(WCUENTA0)) TO WLARCOD
   IF WLARCOD = 30
      STORE WCUENTA0 TO WNOCTA
      ***
      STORE "INVE"   TO WCAMPO
      STORE INVE     TO WMONTOPROC
      DO ACTUALNOM
      ***
      STORE "CORR"   TO WCAMPO
      STORE CORR     TO WMONTOPROC
      DO ACTUALNOM
      ***
      STORE "ORIG"   TO WCAMPO
      STORE ORIG     TO WMONTOPROC
      DO ACTUALNOM
   ENDIF
   SKIP
ENDDO
***** TRASPASOS
select 2
USE PRTRAS INDEX PRTRAS1
do filloc
GO TOP
DO WHILE .NOT. EOF()
   IF SUBSTR(CODIGOPRE,1,2)=WPREANO.AND.SUBSTR(CODIGOPRE,3,2)=WPRETIP.AND.SUBSTR(CODIGOPRE,5,3)=WPREORI)
   ELSE
      SELECT PRTRAS
      SKIP
      LOOP
   ENDIF
   STORE "REPROCESANDO REFORMULACION: "+ORIGEN+", FAVOR ESPERAR..." TO MES
   DO MENSAJE WITH MES
   STORE ORIGEN      TO WCUENTA
   STORE MONTO       TO WMONTO

   STORE WCUENTA     TO WNOCTA
   STORE "TRAS"      TO WCAMPO
   STORE WMONTO*-1   TO WMONTOPROC
   SELECT PRCTAS
   FIND &WCUENTA
   IF EOF()
      STORE "NO ENCONTRE TRASPASO ORIGEN:"+WCUENTA+" Bs."+STR(WMONTO,15,2) TO MES
      DO AVISO WITH MES
      UNLOCK ALL
      RETURN
   ENDIF
   DO ACTUALIZA
   SELECT PRTRAS
   STORE DESTINO     TO WCUENTA
   STORE MONTO       TO WMONTO

   STORE WCUENTA     TO WNOCTA
   STORE "TRAS"      TO WCAMPO
   STORE WMONTO      TO WMONTOPROC
   SELECT PRCTAS
   FIND &WCUENTA
   IF EOF()
      STORE "NO ENCONTRE TRASPASO DESTINO:"+WCUENTA+" Bs."+STR(WMONTO,15,2) TO MES
      DO AVISO WITH MES
      RETURN
   endif
   DO ACTUALIZA
   SELECT PRTRAS
   SKIP
ENDDO
***** INCREMENTOS
SELECT 8
USE PRINCRE INDEX PRINCRE
SEEK WCLAVE
IF FOUND()
   DO WHILE .NOT. EOF() .AND. (PREANO=WPREANO.AND.PRETIP=WPRETIP.AND.PREORI=WPREORI)
      STORE SPACE(30) TO WCTAINCRE
      DO ARMAINC
      STORE "REPROCESANDO INCREMENTO: "+WCTAINCRE+", FAVOR ESPERAR..." TO MES
      DO MENSAJE WITH MES
      STORE WCTAINCRE   TO WNOCTA
      STORE "INCR"      TO WCAMPO
      STORE MONTO       TO WMONTOPROC
      SELECT PRCTAS
      FIND &WCTAINCRE
      IF EOF()
         STORE "NO ENCONTRE INCREMENTO CTA.:"+WCTAINCRE+" Bs."+STR(WMONTOPROC,15,2) TO MES
         DO AVISO WITH MES
         UNLOCK ALL
         RETURN
      ELSE
         DO ACTUALIZA
      ENDIF
      SELECT PRINCRE
      SKIP
   ENDDO
ENDIF
***** COMPROMISOS
SELECT 3
use prcomp index prcomp1,prcomp2,prcomp3
GO TOP
DO WHILE .NOT. EOF()
   IF SUBSTR(CODIGOPRE,1,2)=WPREANO.AND.SUBSTR(CODIGOPRE,3,2)=WPRETIP.AND.SUBSTR(CODIGOPRE,5,3)=WPREORI)
   ELSE
      SELECT PRCOMP
      SKIP
      LOOP
   ENDIF
   STORE CODIGOPRE TO WCUENTA
   STORE MONTOCOMP TO WMONTO
   STORE "REPROCESANDO COMPROMISO: "+WCUENTA+", FAVOR ESPERAR..." TO MES
   DO MENSAJE WITH MES
   STORE WCUENTA  TO WNOCTA
   STORE "COMP"   TO WCAMPO
   STORE WMONTO   TO WMONTOPROC
   SELECT PRCTAS
   FIND &WCUENTA
   IF EOF()
      STORE "NO ENCONTRE COMPROMISO CTA.:"+WCUENTA+" Bs."+STR(WMONTO,15,2) TO MES
      DO AVISO WITH MES
      UNLOCK ALL
      RETURN
   ELSE   
      DO ACTUALIZA
   ENDIF
   SELECT PRCOMP
   SKIP
ENDDO

***** CAUSADOS
SELECT 4
USE PRPAGA INDEX PRPAGA1,PRPAGA2,PRPAGA3
GO TOP
DO WHILE .NOT. EOF()
   IF SUBSTR(CODIGOPRE,1,2)=WPREANO.AND.SUBSTR(CODIGOPRE,3,2)=WPRETIP.AND.SUBSTR(CODIGOPRE,5,3)=WPREORI)
   ELSE
      SELECT PRPAGA
      SKIP
      LOOP
   ENDIF
   STORE CODIGOPRE TO WCUENTA
   STORE MONTOCAUS TO WMONTO
   STORE "REPROCESANDO CAUSADO: "+WCUENTA+", FAVOR ESPERAR..." TO MES
   DO MENSAJE WITH MES
   SELECT PRCTAS
   FIND &WCUENTA
   IF EOF()
      STORE "NO ENCONTRE CAUSADOS DE CUENTA:"+WCUENTA+" Bs."+STR(WMONTO,15,2) TO MES
      DO AVISO WITH MES
      UNLOCK ALL
      RETURN
   ELSE   
      *** CARGA NIVEL DE CAUSADO
      STORE WCUENTA    TO WNOCTA
      STORE "CAUS"     TO WCAMPO
      STORE WMONTO     TO WMONTOPROC
      DO ACTUALIZA
   ENDIF
   SELECT PRPAGA
   SKIP
ENDDO
***** PAGADOS
SELECT PRPAGA
GO TOP
DO WHILE .NOT. EOF()
   IF SUBSTR(CODIGOPRE,1,2)=WPREANO.AND.SUBSTR(CODIGOPRE,3,2)=WPRETIP.AND.SUBSTR(CODIGOPRE,5,3)=WPREORI)
   ELSE
      SELECT PRPAGA
      SKIP
      LOOP
   ENDIF
   STORE CODIGOPRE TO WCUENTA
   STORE MONTOPAGA TO WMONTO
   STORE "REPROCESANDO PAGO: "+WCUENTA+", FAVOR ESPERAR..." TO MES
   DO MENSAJE WITH MES
   SELECT PRCTAS
   FIND &WCUENTA
   IF EOF()
      STORE "NO ENCONTRE PAGOS CTA.:"+WCUENTA+" Bs."+STR(WMONTOC,15,2) TO MES
      DO AVISO WITH MES
      UNLOCK ALL
      RETURN
   ELSE   
      STORE WCUENTA  TO WNOCTA
      STORE "PAGA"   TO WCAMPO
      STORE WMONTO   TO WMONTOPROC
      DO ACTUALIZA
   ENDIF
   SELECT PRPAGA
   SKIP
ENDDO
STORE "OPERACION EFECTUADA SATISFACTORIAMENTE, <ENTER>" TO MES
DO AVISO WITH MES
RETURN
